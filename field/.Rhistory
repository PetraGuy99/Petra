View(mean_data)
summarise_treatment(model)
# Helper function - enter model name below
summarise_treatment <- function(model, treatment_name = "TreatmentPellet") {
library(posterior)
# Extract posterior draws
draws <- as_draws_df(model)
# Control (baseline)
control_draws <- exp(draws$b_Intercept)
control_mean <- mean(control_draws)
control_CrI <- quantile(control_draws, c(0.025, 0.975))
# Treatment
treat_draws <- exp(draws$b_Intercept + draws[[paste0("b_", treatment_name)]])
treat_mean <- mean(treat_draws)
treat_CrI <- quantile(treat_draws, c(0.025, 0.975))
# % increase relative to control
pct_draws <- (treat_draws / control_draws - 1) * 100
pct_mean <- mean(pct_draws)
pct_CrI <- quantile(pct_draws, c(0.025, 0.975))
# Posterior probability treatment > control
prob_positive <- mean(treat_draws > control_draws)
# Return results
data.frame(
Group = c("Control", treatment_name, paste0(treatment_name, "_%increase")),
Mean = c(control_mean, treat_mean, pct_mean),
CI_low = c(control_CrI[1], treat_CrI[1], pct_CrI[1]),
CI_high = c(control_CrI[2], treat_CrI[2], pct_CrI[2]),
Prob_positive = c(NA, prob_positive, prob_positive)
)
}
summarise_treatment(model)
VarCorr(model)
site_var <- draw %>%
mutate(site_var = sd_Site__Intercept^2)
View(site_var)
model_null <- brm(
delta_h ~ 1 + (1 | Site),
data = data,
family = Gamma(link = "log"),
chains = 4, cores = 4,
control = list(adapt_delta = 0.95)
)
#1..Bayes_r2 prop variance in ind which can be explained by dep
R2 = bayes_R2(model_null)
VarCorr(model)
site_var <- draw$sd_Site__Intercept^2
#1..Bayes_r2 prop variance in ind which can be explained by dep
R2 = bayes_R2(model)
#1..Bayes_r2 prop variance in ind which can be explained by dep
R2 = bayes_R2(model)
icc <- posterior_icc(model)
library(brms)
icc <- posterior_icc(model)
library(brms)
?posterior_icc
library(performance) #FOR BAYES r2
icc <- posterior_icc(model)
icc <- icc(model)
VarCorr(model)$Site
bayes_R2(model) - bayes_R2(model_null)
bayes_R2(model_null)
bayes_R2(model) - bayes_R2(model_null)
bayes_R2(model_null)
#plot of % differences between pellet and control across sites by tree sp
#good for highlighting any potential odd ball sites
ggplot(mean_wide, aes(x = Tree_Species, y = percent_diff, fill = Tree_Species)) +
geom_col(position = "dodge") +
facet_wrap(~ Site) +
geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
labs(
x = "Tree Species",
y = "Difference vs Control cm",
title = "Treatment effect relative to Control per Site and Tree Species"
) +
theme_bw() +
theme(
text = element_text(size = 12),
legend.position = "none",
axis.text.x = element_text(angle = 45, hjust = 1)
)
# as above but make a % difference column
mean_wide <- mean_wide %>%
mutate(
diff_vs_control = Pellet - Control, # or Fertiliser - Control, if needed
percent_diff = ((Pellet - Control)/Control)*100
)
#plot of % differences between pellet and control across sites by tree sp
#good for highlighting any potential odd ball sites
ggplot(mean_wide, aes(x = Tree_Species, y = percent_diff, fill = Tree_Species)) +
geom_col(position = "dodge") +
facet_wrap(~ Site) +
geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
labs(
x = "Tree Species",
y = "Difference vs Control cm",
title = "Treatment effect relative to Control per Site and Tree Species"
) +
theme_bw() +
theme(
text = element_text(size = 12),
legend.position = "none",
axis.text.x = element_text(angle = 45, hjust = 1)
)
mean_table <- data %>%
group_by(Site, Tree_Species, Treatment,EMF) %>%
summarise(
mean_delta_h = mean(delta_h, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(Site, Tree_Species, Treatment, EMF)
mean_wide <- mean_table %>%
pivot_wider(
names_from = Treatment,
values_from = mean_delta_h
)
# as above but make a % difference column
mean_wide <- mean_wide %>%
mutate(
diff_vs_control = Pellet - Control, # or Fertiliser - Control, if needed
percent_diff = ((Pellet - Control)/Control)*100
)
#plot of % differences between pellet and control across sites by tree sp
#good for highlighting any potential odd ball sites
ggplot(mean_wide, aes(x = Tree_Species, y = percent_diff, fill = Tree_Species)) +
geom_col(position = "dodge") +
facet_wrap(~ Site) +
geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
labs(
x = "Tree Species",
y = "Difference vs Control cm",
title = "Treatment effect relative to Control per Site and Tree Species"
) +
theme_bw() +
theme(
text = element_text(size = 12),
legend.position = "none",
axis.text.x = element_text(angle = 45, hjust = 1)
)
#same again but by emf - to visualise whether the emf are behaving the same everywhere
ggplot(mean_wide, aes(x = EMF, y = percent_diff, fill = EMF)) +
geom_col(position = "dodge") +   # bar plot; use geom_point() for points
facet_wrap(~ Site) +             # one facet per site
geom_hline(yintercept = 0, linetype = "dashed", color = "red") +  # line at zero
labs(
x = "EMF",
y = "Difference vs Control %",
title = "Treatment effect relative to Control per Site and EMF"
) +
theme_bw() +
theme(
text = element_text(size = 12),
legend.position = "none"
)
sheets <- excel_sheets('../../../data/field/Galbraith2025.xlsx')  # get sheet names
# read all sheets into a named list, suppressing the New names messages
all_sheets <- suppressMessages(
lapply(sheets, function(s) {
read_excel('../../../data/field/Galbraith2025.xlsx', sheet = s)
})
)
#names(all_sheets) <- sheets
#remove meta
all_sheets <- all_sheets[-c(1,2)]
#subest which have rcd
all_sheets = all_sheets[c(4,6,10,12,27,25)]
#add change in rcd
all_sheets <- map(all_sheets, ~ .x %>%
mutate(delta_rcd   = Rcd_1 - Rcd_0))
all_sheets <- map(
all_sheets,
~ .x %>% dplyr::select(any_of(c("Tree_Species", "Fungi_Treatment", "delta_rcd")))
)
#now to fix the Treatment columns, Col name Fungi_Treatment becomes Treatment,
all_sheets <- map(
all_sheets,
~ .x %>%
dplyr::rename(Treatment = Fungi_Treatment) %>%
dplyr::mutate(
Treatment = dplyr::recode(
Treatment,
Fungi_control = "Control",
Treatment = 'Pellet'
)
)
)
#bind sheets 1.12,1.13 etc and allocate as site BA1, 2.12, 2.13 etc and allocate as site BA2
df_long_BA <- imap_dfr(
all_sheets,
~ .x %>%
mutate(
Site = 'BA'
)
)
#add emf - but we're not sure whats heb and pax, so this site is just EMF
df_long_BA$EMF = 'PAX'
ggplot(df_long_BA, aes(x = Treatment, y = delta_rcd)) +
geom_boxplot(fill = "skyblue", alpha = 0.5) +
geom_jitter(width = 0.1, alpha = 0.3) +  # optional: show raw points
labs(
x = "Treatment",
y = expression(Delta ~ RCD),
title = "Change in RCD by Treatment"
) +
theme_classic()
#########################################################
sheets <- excel_sheets('../../../data/field/TilhillOlivia2025.xlsx')  # get sheet names
# read all sheets into a named list, suppressing the New names messages
all_sheets <- suppressMessages(
lapply(sheets, function(s) {
read_excel('../../../data/field/TilhillOlivia2025.xlsx', sheet = s)
})
)
names(all_sheets) <- sheets
all_sheets <- all_sheets[-c(1,2)]
#add change in rcd
all_sheets <- map(all_sheets, ~ .x %>%
mutate(delta_rcd   = Rcd_mm_1 - Rcd_mm_0))
all_sheets <-  map(all_sheets, ~ .x %>%
dplyr::select(Tree_Species, Treatment, delta_rcd))
all_sheets <- map(
all_sheets,
~ .x %>%
dplyr::mutate(
Treatment = dplyr::recode(
Treatment,
Fungi_Control = "Control",
Treatment = 'Pellet'
)
))
#make long df, not taking plots nested within site, too complex, just treat as single site
#make long df
df_long_BB <- bind_rows( all_sheets)
#add site names
df_long_BB$Site = 'BB'
df_long_BB$EMF = 'LACAM'
ggplot(df_long_BB, aes(x = Treatment, y = delta_rcd)) +
geom_boxplot(fill = "skyblue", alpha = 0.5) +
geom_jitter(width = 0.1, alpha = 0.3) +  # optional: show raw points
labs(
x = "Treatment",
y = expression(Delta ~ RCD),
title = "Change in RCD by Treatment"
) +
theme_classic()
sheets <- excel_sheets('../../../data/field/TilhillOlivia2025.xlsx')  # get sheet names
# read all sheets into a named list, suppressing the New names messages
all_sheets <- suppressMessages(
lapply(sheets, function(s) {
read_excel('../../../data/field/TilhillOlivia2025.xlsx', sheet = s)
})
)
names(all_sheets) <- sheets
all_sheets <- all_sheets[-c(1,2)]
#add change in rcd
all_sheets <- map(all_sheets, ~ .x %>%
mutate(delta_rcd   = Rcd_mm_1 - Rcd_mm_0))
all_sheets <-  map(all_sheets, ~ .x %>%
dplyr::select(Tree_Species, Treatment, delta_rcd))
all_sheets <- map(
all_sheets,
~ .x %>%
dplyr::mutate(
Treatment = dplyr::recode(
Treatment,
Fungi_Control = "Control",
Treatment = 'Pellet'
)
))
#make long df, not taking plots nested within site, too complex, just treat as single site
#make long df
df_long_BB <- bind_rows( all_sheets)
#add site names
df_long_BB$Site = 'BB'
df_long_BB$EMF = 'LACAM'
ggplot(df_long_BB, aes(x = Treatment, y = delta_rcd)) +
geom_boxplot(fill = "skyblue", alpha = 0.5) +
geom_jitter(width = 0.1, alpha = 0.3) +  # optional: show raw points
labs(
x = "Treatment",
y = expression(Delta ~ RCD),
title = "Change in RCD by Treatment"
) +
theme_classic()
View(df_long_BB)
View(df_long_BB)
parallel::detectCores()
sheets <- excel_sheets('../../../data/field/TilhillOlivia2025.xlsx')  # get sheet names
# read all sheets into a named list, suppressing the New names messages
all_sheets <- suppressMessages(
lapply(sheets, function(s) {
read_excel('../../../data/field/TilhillOlivia2025.xlsx', sheet = s)
})
)
names(all_sheets) <- sheets
all_sheets <- all_sheets[-c(1,2)]
#add change in rcd
all_sheets <- map(all_sheets, ~ .x %>%
mutate(delta_rcd   = Rcd_mm_1 - Rcd_mm_0))
all_sheets <-  map(all_sheets, ~ .x %>%
dplyr::select(Tree_Species, Treatment, delta_rcd))
all_sheets <- map(
all_sheets,
~ .x %>%
dplyr::mutate(
Treatment = dplyr::recode(
Treatment,
Fungi_Control = "Control",
Treatment = 'Pellet'
)
))
#make long df, not taking plots nested within site, too complex, just treat as single site
#make long df
df_long_BB <- bind_rows( all_sheets)
#add site names
df_long_BB$Site = 'BB'
df_long_BB$EMF = 'LACAM'
ggplot(df_long_BB, aes(x = Treatment, y = delta_rcd)) +
geom_boxplot(fill = "skyblue", alpha = 0.5) +
geom_jitter(width = 0.1, alpha = 0.3) +  # optional: show raw points
labs(
x = "Treatment",
y = expression(Delta ~ RCD),
title = "Change in RCD by Treatment"
) +
theme_classic()
sheets <- excel_sheets('../../../data/field/TilhillOlivia2025.xlsx')  # get sheet names
# read all sheets into a named list, suppressing the New names messages
all_sheets <- suppressMessages(
lapply(sheets, function(s) {
read_excel('../../../data/field/TilhillOlivia2025.xlsx', sheet = s)
})
)
names(all_sheets) <- sheets
all_sheets <- all_sheets[-c(1,2)]
#add change in rcd
all_sheets <- map(all_sheets, ~ .x %>%
mutate(delta_rcd   = Rcd_mm_1 - Rcd_mm_0))
all_sheets <-  map(all_sheets, ~ .x %>%
dplyr::select(Tree_Species, Treatment, delta_rcd))
all_sheets <- map(
all_sheets,
~ .x %>%
dplyr::mutate(
Treatment = dplyr::recode(
Treatment,
Fungi_Control = "Control",
Treatment = 'Pellet'
)
))
#make long df, not taking plots nested within site, too complex, just treat as single site
#make long df
df_long_BB <- bind_rows( all_sheets)
#add site names
df_long_BB$Site = 'BB'
df_long_BB$EMF = 'LACAM'
ggplot(df_long_BB, aes(x = Treatment, y = delta_rcd)) +
geom_boxplot(fill = "skyblue", alpha = 0.5) +
geom_jitter(width = 0.1, alpha = 0.3) +  # optional: show raw points
labs(
x = "Treatment",
y = expression(Delta ~ RCD),
title = "Change in RCD by Treatment"
) +
theme_classic()
sheets <- excel_sheets('../../../data/field/Tievedooly2025.xlsx')  # get sheet names
# read all sheets into a named list, suppressing the New names messages
all_sheets <- suppressMessages(
lapply(sheets, function(s) {
read_excel('../../../data/field/Tievedooly2025.xlsx', sheet = s)
})
)
names(all_sheets) <- sheets
#remove meta etc
all_sheets <- all_sheets[-c(1,2)]
sheets <- excel_sheets('../../../data/field/GreshamKathryn2025.xlsx')  # get sheet names
# read all sheets into a named list, suppressing the New names messages
all_sheets <- suppressMessages(
lapply(sheets, function(s) {
read_excel('../../../data/field/GreshamKathryn2025.xlsx', sheet = s)
})
)
names(all_sheets) <- sheets
#dont want the Pellet Control plot - where blank pellet was used, just need combine plot
#where treatment and control were put together
all_sheets <- all_sheets[3]
sheets <- excel_sheets('../../../data/field/GreshamKathryn2025.xlsx')  # get sheet names
# read all sheets into a named list, suppressing the New names messages
all_sheets <- suppressMessages(
lapply(sheets, function(s) {
read_excel('../../../data/field/GreshamKathryn2025.xlsx', sheet = s)
})
)
names(all_sheets) <- sheets
#dont want the Pellet Control plot - where blank pellet was used, just need combine plot
#where treatment and control were put together
all_sheets <- all_sheets[c(1,2)]
#add change in rcd
all_sheets <- map(all_sheets, ~ .x %>%
mutate(delta_rcd   = Rcd_1 - Rcd_0))
all_sheets <-  map(all_sheets, ~ .x %>%
dplyr::select(Tree_Species, Treatment,  delta_rcd))
all_sheets <- map(
all_sheets,
~ .x %>%
dplyr::mutate(
Treatment = dplyr::recode(
Treatment,
Fungi_Control = "Control",
Treatment = 'Pellet'
)
))
df_long_BJ <- bind_rows( all_sheets)
#add site name
df_long_BJ$Site = 'BJ'
df_long_BJ$EMF = 'AMRUB'
ggplot(df_long_BJ, aes(x = Treatment, y = delta_rcd)) +
geom_boxplot(fill = "skyblue", alpha = 0.5) +
geom_jitter(width = 0.1, alpha = 0.3) +  # optional: show raw points
labs(
x = "Treatment",
y = expression(Delta ~ RCD),
title = "Change in RCD by Treatment"
) +
theme_classic()
sheets <- excel_sheets('../../../data/field/Tievedooly2025.xlsx')  # get sheet names
# read all sheets into a named list, suppressing the New names messages
all_sheets <- suppressMessages(
lapply(sheets, function(s) {
read_excel('../../../data/field/Tievedooly2025.xlsx', sheet = s)
})
)
names(all_sheets) <- sheets
#remove meta etc
all_sheets <- all_sheets[-c(1,2)]
#add the delta_h in now
all_sheets <- map(all_sheets, ~ .x %>%
mutate(
delta_rcd   = Rcd_1 - Rcd_0 ))
all_sheets <-  map(all_sheets, ~ .x %>%
dplyr::select(Tree_Species,  Treatment,  delta_rcd))
df_long_BK <- bind_rows( all_sheets)
df_long_BK$Site = 'BK'
df_long_BK$EMF = 'PAX'
ggplot(df_long_BK, aes(x = Treatment, y = delta_rcd)) +
geom_boxplot(fill = "skyblue", alpha = 0.5) +
geom_jitter(width = 0.1, alpha = 0.3) +  # optional: show raw points
labs(
x = "Treatment",
y = expression(Delta ~ RCD),
title = "Change in RCD by Treatment"
) +
theme_classic()
View(df_long_BK)
View(df_long_BK)
sheets <- excel_sheets('../../../data/field/Tievedooly2025.xlsx')  # get sheet names
# read all sheets into a named list, suppressing the New names messages
all_sheets <- suppressMessages(
lapply(sheets, function(s) {
read_excel('../../../data/field/Tievedooly2025.xlsx', sheet = s)
})
)
names(all_sheets) <- sheets
#remove meta etc
all_sheets <- all_sheets[-c(1,2)]
#add the delta_h in now
all_sheets <- map(all_sheets, ~ .x %>%
mutate(
delta_rcd   = Rcd_1 - Rcd_0 ))
all_sheets <-  map(all_sheets, ~ .x %>%
dplyr::select(Tree_Species,  Treatment,  delta_rcd))
df_long_BK <- bind_rows( all_sheets)
df_long_BK$Site = 'BK'
df_long_BK$EMF = 'PAX'
ggplot(df_long_BK, aes(x = Treatment, y = delta_rcd)) +
geom_boxplot(fill = "skyblue", alpha = 0.5) +
geom_jitter(width = 0.1, alpha = 0.3) +  # optional: show raw points
labs(
x = "Treatment",
y = expression(Delta ~ RCD),
title = "Change in RCD by Treatment"
) +
theme_classic()
#########################################################
sheets <- excel_sheets('../../../data/field/Tievedooly2025.xlsx')  # get sheet names
# read all sheets into a named list, suppressing the New names messages
all_sheets <- suppressMessages(
lapply(sheets, function(s) {
read_excel('../../../data/field/Tievedooly2025.xlsx', sheet = s)
})
)
names(all_sheets) <- sheets
#remove meta etc
all_sheets <- all_sheets[-c(1,2)]
#add the delta_h in now
all_sheets <- map(all_sheets, ~ .x %>%
mutate(
delta_rcd   = Rcd_1 - Rcd_0 ))
all_sheets <-  map(all_sheets, ~ .x %>%
dplyr::select(Tree_Species,  Treatment,  delta_rcd))
df_long_BK <- bind_rows( all_sheets)
df_long_BK$Site = 'BK'
df_long_BK$EMF = 'PAX'
ggplot(df_long_BK, aes(x = Treatment, y = delta_rcd)) +
geom_boxplot(fill = "skyblue", alpha = 0.5) +
geom_jitter(width = 0.1, alpha = 0.3) +  # optional: show raw points
labs(
x = "Treatment",
y = expression(Delta ~ RCD),
title = "Change in RCD by Treatment"
) +
theme_classic()
#####################################################
